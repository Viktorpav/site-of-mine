AWSTemplateFormatVersion: "2010-09-09"
Description: Monitoring of the static site

Parameters:
  Prefix:
    Description: Prefix for the general name
    Type: String

# Create an SNS topic for sending budget alarm notifications
Resources:
  SNSTopic:
    Type: AWS::SNS::Topic
    Description: "Topic for sending budget alarm notifications"
    Properties:
      DisplayName: !Sub "${Prefix}-topic"
      TopicName: !Sub "${Prefix}-topic"

# Create a budget for monitoring S3 and CloudFront costs
  Budget: 
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub "${Prefix}-budget"
        BudgetType: COST
        TimeUnit: MONTHLY
        BudgetLimit:
          Amount: 1
          Unit: USD
        CostFilters:
          Service: [S3, CloudFront]
          
# Create a CloudWatch Alarm for monitoring S3 costs
  Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Prefix}-cost-alarm"
      AlarmDescription: "Alarm when cost exceeds $1 for S3 and CloudFront services"
      MetricName: EstimatedCharges
      Namespace: AWS/Billing
      Statistic: SAMPLE_COUNT
      Period: 86400
      EvaluationPeriods: 1
      Threshold: 1
      AlarmAction:
        - !Ref SNSTopic
      AlarmActionsEnabled: true
      Dimensions:
        ServiceName: s3
      AlarmDisplayName: "EstimatedCharges"
      Notification:
        NotificationType: ACTUAL
        ComparisonOperator: GREATER_THAN_EQUAL_TO
        Threshold: 100
        ThresholdType: ABSOLUTE_VALUE
        NotificationState: ALARM
        NotificationProperties:
          SnsTopicArn: !Ref SNSTopic
